package Libraries.Development.Environment.Studio
use Libraries.Development.Environment.Resources
use Libraries.Game.Graphics.Gradient
use Libraries.Game.Graphics.Color
use Libraries.Game.InputTable
use Libraries.Game.GameStateManager
use Libraries.Development.Environment.Studio.Behaviors.Behaviors
use Libraries.Containers.Array
use Libraries.Interface.Controls.MenuItem
use Libraries.Interface.Controls.MenuBar
use Libraries.Development.Environment.Studio.Behaviors.MenuHotkeyBehavior
use Libraries.Game.InputSet
use Libraries.Interface.Events.KeyboardEvent
use Libraries.Development.Environment.Studio.Interface.KeyMap
use Libraries.Interface.Selections.MenuSelection
use Libraries.Development.Environment.Studio.Behaviors.DefaultMenuOpenBehavior
use Libraries.Interface.Events.FocusEvent
use Libraries.Interface.Layouts.LayoutProperties
use Libraries.Interface.Events.SelectionListener
use Libraries.Interface.Events.SelectionEvent
use Libraries.Development.Environment.Studio.Behaviors.CheckForUpdatesBehavior
use Libraries.Development.Environment.Studio.Behaviors.AboutBoxBehavior

class Menu is MenuBar, SelectionListener
    KeyboardEvent keys
    MenuItem fileMenu
    MenuItem editMenu
    MenuItem viewMenu
    MenuItem navigateMenu
    MenuItem teamMenu
    MenuItem runMenu
    MenuItem windowsMenu
    MenuItem helpMenu

    MenuItem newProject
    MenuItem defaultMenuItem = undefined
    Resources resources = undefined
    KeyMap keyMap = undefined
    Gradient gradient
    Color color
    number height = 0
    Behaviors behaviors = undefined

    on create
        gradient:Set(color:LightGray(), color:LightGray(), color:White(), color:White())
        SetName("Menu")
    end
  
    action GetBehaviors returns Behaviors
        return behaviors
    end

    action SetBehaviors(Behaviors behaviors)
        me:behaviors = behaviors
    end

    action SetToDefaultSelection
        Array<MenuItem> items
        items:Add(fileMenu)
        Select(items)
    end

    action SetDefaultPopupShortcut
        GameStateManager manager
        InputTable table = manager:GetGame():GetDefaultInputTable()
        table:Add(keyMap:GetDefaultMenuPopup1(), behaviors:GetDefaultMenuOpenBehavior())
        table:Add(keyMap:GetDefaultMenuPopup2(), behaviors:GetDefaultMenuOpenBehavior())
        table:Add(keyMap:GetDefaultMenuPopup3(), behaviors:GetDefaultMenuOpenBehavior())
    end

    action SetDisplayOffset(number value)
        height = value
    end

    action GetDisplayOffset returns number
        return height
    end

    action GetResources returns Resources
        return resources
    end

    action SetResources(Resources resources)
        me:resources = resources
        me:keyMap = resources:GetKeyMap()
    end

    action Setup
        SetupFileMenu()
        SetupEditMenu()
        SetupViewMenu()
        SetupNavigateMenu()
        SetupTeamMenu()
        SetupRunMenu()
        SetupWindowsMenu()
        SetupHelpMenu()

        Array<MenuItem> menuItems
        menuItems:Add(fileMenu)
        menuItems:Add(editMenu)
        menuItems:Add(viewMenu)
        menuItems:Add(navigateMenu)
        menuItems:Add(teamMenu)
        menuItems:Add(runMenu)
        menuItems:Add(windowsMenu)
        menuItems:Add(helpMenu)
        Add(menuItems)
        SetSelectingState(false)
        SetDefaultPopupShortcut()
    end

    //Adding the mouse listeners will give unintended results for now
    private action SetupFileMenu
        Array<MenuItem> fileItems
        
        
        defaultMenuItem = newProject
        newProject:SetName("New Project")
        newProject:SetShortcut(keyMap:GetNewProjectKey())
        newProject:SetBehavior(behaviors:GetOpenNewProjectBehavior())
        fileItems:Add(newProject)

        MenuItem newFile
        newFile:SetName("New File")
        newFile:SetShortcut(keyMap:GetNewFileKey())
        newFile:SetBehavior(behaviors:GetOpenNewFileBehavior())
        fileItems:Add(newFile)
        
        // The openProject is instead declared as a field so it can be used
        // later in SetupMenuHotkeys().
        MenuItem openProject
        openProject:SetName("Open Project")
        openProject:SetShortcut(keyMap:GetOpenProjectKey())
        openProject:SetBehavior(behaviors:GetOpenProjectBehavior())
        fileItems:Add(openProject)

        MenuItem closeProject
        closeProject:SetName("Close Project")
        closeProject:SetShortcut(keyMap:GetCloseProjectKey())
        closeProject:SetBehavior(behaviors:GetCloseProjectBehavior())
        fileItems:Add(closeProject)

        MenuItem save
        save:SetName("Save")
        save:SetBehavior(behaviors:GetSaveBehavior())
        save:SetShortcut(keyMap:GetSaveKey())
        fileItems:Add(save)

        MenuItem saveAll
        saveAll:SetName("Save All")
        saveAll:SetShortcut(keyMap:GetSaveAllKey())
        saveAll:SetBehavior(behaviors:GetSaveAllBehavior())
        fileItems:Add(saveAll)

        MenuItem exit
        exit:SetName("Exit")
        exit:SetBehavior(behaviors:GetExitBehavior())
        exit:SetShortcut(keyMap:GetExitKey())
        fileItems:Add(exit)

        fileMenu:SetName("File")
        fileMenu:Add(fileItems)
    end

    private action SetupEditMenu
        Array<MenuItem> editItems

        MenuItem undo
        undo:SetName("Undo")
        undo:SetShortcut(keyMap:GetUndoKey())
        undo:SetBehavior(behaviors:GetUndoBehavior())
        editItems:Add(undo)

        MenuItem redo
        redo:SetName("Redo")
        redo:SetShortcut(keyMap:GetRedoKey())
        redo:SetBehavior(behaviors:GetRedoBehavior())
        editItems:Add(redo)

        MenuItem cut
        cut:SetName("Cut")
        cut:SetShortcut(keyMap:GetCutKey())
        cut:SetBehavior(behaviors:GetCutBehavior())
        editItems:Add(cut)

        MenuItem copy
        copy:SetName("Copy")
        copy:SetShortcut(keyMap:GetCopyKey())
        copy:SetBehavior(behaviors:GetCopyBehavior())
        editItems:Add(copy)

        MenuItem paste
        paste:SetName("Paste")
        paste:SetShortcut(keyMap:GetPasteKey())
        paste:SetBehavior(behaviors:GetPasteBehavior())
        editItems:Add(paste)

        MenuItem delete
        delete:SetName("Delete")
        delete:SetShortcut(keyMap:GetDeleteKey())
        delete:SetBehavior(behaviors:GetDeleteBehavior())
        editItems:Add(delete)

        MenuItem selectAll
        selectAll:SetName("Select All")
        selectAll:SetShortcut(keyMap:GetSelectAllKey())
        selectAll:SetBehavior(behaviors:GetSelectAllBehavior())
        editItems:Add(selectAll)

        MenuItem find
        find:SetName("Find")
        find:SetShortcut(keyMap:GetFindKey())
        find:SetBehavior(behaviors:GetFindDialogSelectionBehavior())
        //find:SetBehavior(behaviors:GetOpenFindDialogBehavior())
        editItems:Add(find)

        MenuItem replace
        replace:SetName("Replace")
        replace:SetShortcut(keyMap:GetReplaceKey())
        replace:SetBehavior(behaviors:GetOpenReplaceDialogBehavior())
        editItems:Add(replace)

//        MenuItem findInProject
//        findInProject:SetName("Find In Project")
//        //findInProject:SetShortcut(keyMap:GetFindInProjectKey())
//        findInProject:SetBehavior(behaviors:GetOpenFindInProjectDialogBehavior())
//        editItems:Add(findInProject)

        MenuItem comment
        comment:SetName("Comment")
        comment:SetShortcut(keyMap:GetCommentLinesKey())
        comment:SetBehavior(behaviors:GetCommentLineBehavior())
        editItems:Add(comment)

        MenuItem hint
        hint:SetName("Do Hint")
        hint:SetShortcut(keyMap:GetEditorHintKey())
        hint:SetBehavior(behaviors:GetEditorHintBehavior())
        editItems:Add(hint)

        MenuItem projectProperties
        projectProperties:SetName("Edit Project Properties")
        projectProperties:SetShortcut(keyMap:GetProjectPropertiesKey())
        projectProperties:SetBehavior(behaviors:GetOpenProjectPropertiesBehavior())
        editItems:Add(projectProperties)

        editMenu:SetName("Edit")
        editMenu:Add(editItems)
    end

    private action SetupViewMenu
        Array<MenuItem> viewItems

        MenuItem zoomIn
        zoomIn:SetName("Zoom In")
        zoomIn:SetShortcut(keyMap:GetScaleInterfaceUpKey())
        zoomIn:SetBehavior(behaviors:GetScaleInterfaceUpBehavior())
        viewItems:Add(zoomIn)

        MenuItem zoomOut
        zoomOut:SetName("Zoom Out")
        zoomOut:SetShortcut(keyMap:GetScaleInterfaceDownKey())
        zoomOut:SetBehavior(behaviors:GetScaleInterfaceDownBehavior())
        viewItems:Add(zoomOut)

        viewMenu:SetName("View")
        viewMenu:Add(viewItems)
    end
    
    private action SetupNavigateMenu
        Array<MenuItem> navigateItems

        MenuItem goToLine
        goToLine:SetName("Go to Line")
        goToLine:SetShortcut(keyMap:GetGotoLineKey())
        goToLine:SetBehavior(behaviors:GetGoToLineBehavior())
        navigateItems:Add(goToLine)

        MenuItem smartUp
        smartUp:SetName("Previous Action")
        smartUp:SetShortcut(keyMap:GetSmartNavigateUpKey())
        smartUp:SetBehavior(behaviors:GetEditorSmartNavigationUp())
        navigateItems:Add(smartUp)

        MenuItem smartDown
        smartDown:SetName("Next Action")
        smartDown:SetShortcut(keyMap:GetSmartNavigateDownKey())
        smartDown:SetBehavior(behaviors:GetEditorSmartNavigationDown())
        navigateItems:Add(smartDown)

        MenuItem smartLeft
        smartLeft:SetName("Previous Scope")
        smartLeft:SetShortcut(keyMap:GetSmartNavigateLeftKey())
        smartLeft:SetBehavior( behaviors:GetEditorSmartNavigationLeft())
        navigateItems:Add(smartLeft)

        MenuItem smartRight
        smartRight:SetName("Next Scope")
        smartRight:SetShortcut(keyMap:GetSmartNavigateRightKey())
        smartRight:SetBehavior(behaviors:GetEditorSmartNavigationRight())
        navigateItems:Add(smartRight)

        MenuItem navigateDeclaration
        navigateDeclaration:SetName("Navigate to Selected")
        navigateDeclaration:SetShortcut(keyMap:GetNavigateToSelectedKey())
        navigateDeclaration:SetBehavior(behaviors:GetNavigateToDeclarationBehavior())
        navigateItems:Add(navigateDeclaration)

        navigateMenu:SetName("Navigate")
        navigateMenu:Add(navigateItems)
    end

    private action SetupTeamMenu
        Array<MenuItem> teamItems

        MenuItem pullMenuItem
        pullMenuItem:SetName("Pull")
        pullMenuItem:SetShortcut(keyMap:GetPullRequestKey())
        pullMenuItem:SetBehavior(behaviors:GetThreadedPullRequestBehavior())
        teamItems:Add(pullMenuItem)

        teamMenu:SetName("Team")
        teamMenu:Add(teamItems)
    end

    private action SetupRunMenu
        Array<MenuItem> runItems

        MenuItem build
        build:SetName("Build")
        build:SetShortcut(keyMap:GetBuildKey())
        build:SetBehavior(behaviors:GetThreadedBuildProjectBehavior())
        runItems:Add(build)

        MenuItem clean
        clean:SetName("Clean")
        clean:SetShortcut(keyMap:GetCleanKey())
        clean:SetBehavior(behaviors:GetThreadedCleanProjectBehavior())
        runItems:Add(clean)

        MenuItem cleanAndBuild
        cleanAndBuild:SetName("Clean and Build")
        cleanAndBuild:SetShortcut(keyMap:GetCleanBuildKey())
        cleanAndBuild:SetBehavior(behaviors:GetThreadedCleanBuildProjectBehavior())
        runItems:Add(cleanAndBuild)

        MenuItem run
        run:SetName("Run")
        run:SetShortcut(keyMap:GetRunKey())
        run:SetBehavior(behaviors:GetThreadedRunProjectBehavior())
        runItems:Add(run)

        MenuItem debug
        debug:SetName("Debug")
        debug:SetShortcut(keyMap:GetDebugKey())
        debug:SetBehavior(behaviors:GetThreadedDebugProjectBehavior())
        runItems:Add(debug)

        MenuItem stopDebug
        stopDebug:SetName("Stop")
        stopDebug:SetShortcut(keyMap:GetStopKey())
        stopDebug:SetBehavior(behaviors:GetThreadedStopBehavior())
        runItems:Add(stopDebug)

        MenuItem pauseDebug
        pauseDebug:SetName("Pause")
        pauseDebug:SetShortcut(keyMap:GetPauseKey())
        pauseDebug:SetBehavior(behaviors:GetThreadedPauseBehavior())
        runItems:Add(pauseDebug)

        MenuItem continueDebug
        continueDebug:SetName("Continue")
        continueDebug:SetShortcut(keyMap:GetContinueKey())
        continueDebug:SetBehavior(behaviors:GetThreadedContinueBehavior())
        runItems:Add(continueDebug)

        MenuItem stepOver
        stepOver:SetName("Step Over")
        stepOver:SetShortcut(keyMap:GetStepOverKey())
        stepOver:SetBehavior(behaviors:GetThreadedStepOverBehavior())
        runItems:Add(stepOver)

        MenuItem stepInto
        stepInto:SetName("Step Into")
        stepInto:SetShortcut(keyMap:GetStepIntoKey())
        stepInto:SetBehavior(behaviors:GetThreadedStepIntoBehavior())
        runItems:Add(stepInto)

        MenuItem stepOut
        stepOut:SetName("Step Out")
        stepOut:SetShortcut(keyMap:GetStepOutKey())
        stepOut:SetBehavior(behaviors:GetThreadedStepOutBehavior())
        runItems:Add(stepOut)

        MenuItem runToCursor
        runToCursor:SetName("Run to Cursor")
        runToCursor:SetShortcut(keyMap:GetRunToCursorKey())
        runToCursor:SetBehavior(behaviors:GetThreadedRunToCursorBehavior())
        runItems:Add(runToCursor)

        MenuItem toggleBreakpoint
        toggleBreakpoint:SetName("Toggle Breakpoint")
        toggleBreakpoint:SetShortcut(keyMap:GetToggleBreakpointKey())
        toggleBreakpoint:SetBehavior(behaviors:GetToggleBreakpointBehavior())
        runItems:Add(toggleBreakpoint)

        MenuItem setProgramStart
        setProgramStart:SetName("Set Program Start")
        setProgramStart:SetShortcut(keyMap:GetSetProgramStartKey())
        setProgramStart:SetBehavior(behaviors:GetSetProgramStartBehavior())
        runItems:Add(setProgramStart)

        MenuItem sendToAndroidDebugMode
        sendToAndroidDebugMode:SetName("Send to Android")
        sendToAndroidDebugMode:SetShortcut(keyMap:GetSendToAndroidKey())
        sendToAndroidDebugMode:SetBehavior(behaviors:GetThreadedSendToAndroidDebugModeBehavior())
        runItems:Add(sendToAndroidDebugMode)

        runMenu:SetName("Run")
        runMenu:Add(runItems)
    end

    private action SetupWindowsMenu
        Array<MenuItem> windowsItems

        MenuItem focusNextWindow
        focusNextWindow:SetName("Focus Next Window")
        focusNextWindow:SetBehavior(behaviors:GetFocusNextWindowBehavior())
        focusNextWindow:SetShortcut(keyMap:GetFocusNextWindowKey())
        windowsItems:Add(focusNextWindow)

        MenuItem focusPreviousWindow
        focusPreviousWindow:SetName("Focus Previous Window")
        focusPreviousWindow:SetBehavior(behaviors:GetFocusPreviousWindowBehavior())
        focusPreviousWindow:SetShortcut(keyMap:GetFocusPreviousWindowKey())
        windowsItems:Add(focusPreviousWindow)


        MenuItem projects
        projects:SetName("Projects")
        projects:SetBehavior(behaviors:GetFocusProjectsBehavior())
        projects:SetShortcut(keyMap:GetFocusToProjectsKey())
        windowsItems:Add(projects)

        MenuItem editor
        editor:SetName("Editor")
        editor:SetBehavior(behaviors:GetFocusEditorBehavior())
        editor:SetShortcut(keyMap:GetFocusToEditorKey())
        windowsItems:Add(editor)

        MenuItem outputTab
        outputTab:SetName("Output")
        outputTab:SetBehavior(behaviors:GetFocusOutputBehavior())
        outputTab:SetShortcut(keyMap:GetFocusToOutputKey())
        windowsItems:Add(outputTab)

        MenuItem errors
        errors:SetName("Errors")
        errors:SetBehavior(behaviors:GetFocusErrorsBehavior())
        errors:SetShortcut(keyMap:GetFocusToErrorsKey())
        windowsItems:Add(errors)

        MenuItem variables
        variables:SetName("Variables")
        variables:SetBehavior(behaviors:GetFocusVariablesBehavior())
        variables:SetShortcut(keyMap:GetFocusToVariablesKey())
        windowsItems:Add(variables)

        MenuItem breakpoints
        breakpoints:SetName("Breakpoints")
        breakpoints:SetBehavior(behaviors:GetFocusBreakpointsBehavior())
        breakpoints:SetShortcut(keyMap:GetFocusToBreakpointsKey())
        windowsItems:Add(breakpoints)

        MenuItem callStack
        callStack:SetName("Call Stack")
        callStack:SetBehavior(behaviors:GetFocusCallStackBehavior())
        callStack:SetShortcut(keyMap:GetFocusToCallStackKey())
        windowsItems:Add(callStack)

        MenuItem searchResults
        searchResults:SetName("Search Results")
        searchResults:SetBehavior(behaviors:GetFocusSearchResultsBehavior())
        searchResults:SetShortcut(keyMap:GetFocusToSearchResultsKey())
        windowsItems:Add(searchResults)

        windowsMenu:SetName("Windows")
        windowsMenu:Add(windowsItems)
    end

    private action SetupHelpMenu
        Array<MenuItem> helpItems

        MenuItem about
        about:SetName("About")
        AboutBoxBehavior aboutBehavior
        about:SetBehavior(aboutBehavior)
        helpItems:Add(about)

        MenuItem checkForUpdates
        checkForUpdates:SetName("Check for Updates")
        
        CheckForUpdatesBehavior updates
        checkForUpdates:SetBehavior(updates)
        helpItems:Add(checkForUpdates)

        helpMenu:SetName("Help")
        helpMenu:Add(helpItems)
    end
end
